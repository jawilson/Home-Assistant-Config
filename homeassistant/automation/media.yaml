- alias: 'SHIELD Plex Playing'
  trigger:
    - platform: state
      entity_id: media_player.shield
      to: 'playing'
  condition:
    - condition: state
      entity_id: input_boolean.media_automation
      state: 'on'
  action:
    - service: python_script.shield_plex_playing
    # Turn off the rest of the lights if we haven't started dinner in the last hour
    - condition: template
      value_template: >
        {{ (as_timestamp(now()) - as_timestamp(states.script.dinner.attributes.last_triggered)|float)/60 > 60 }}
    - service: light.turn_off
      entity_id: light.living_room

- alias: 'SHIELD Plex Idle'
  trigger:
    - platform: state
      entity_id: media_player.plex_shield
      to: 'idle'
  condition:
    - condition: template
      value_template: >
        {{ trigger.from_state.state != 'idle' and trigger.from_state.state != 'unavailable' }}
    - condition: state
      entity_id: input_boolean.media_automation
      state: 'on'
    - condition: state
      entity_id: light.living_room_lamp
      state: 'off'
  action:
    - service: switch.turn_off
      entity_id: switch.living_area_fluxer
    - service: light.turn_on
      entity_id: light.living_room
      data:
        profile: nightlight
        transition: 15

- alias: 'Projector Off'
  trigger:
    - platform: state
      entity_id: remote.living_room
      from: 'on'
      to: 'off'
  condition:
    - condition: state
      entity_id: input_boolean.media_automation
      state: 'on'
  action:
    - service: python_script.call_service_if_state
      data:
        service: light.turn_on
        state: 'off'
        entity_id:
          - light.living_room
          - light.kitchen
          - light.entryway
        data:
          profile: nightlight
    - service: python_script.call_service_if_state
      data:
        service: light.turn_on
        state: 'off'
        entity_id: light.dining_lights_level
        data:
          brightness_pct: 2
    - service: switch.turn_on
      entity_id: switch.living_area_fluxer
    - service: switch.entryway_fluxer_update
    - service: switch.living_room_fluxer_update
    - service: switch.kitchen_fluxer_update
    - service: switch.dining_fluxer_update

- alias: 'Update Source Select'
  trigger:
    platform: state
    entity_id: remote.living_room
  action:
    service: input_select.select_option
    data:
      entity_id: input_select.living_room_activity
      option: '{{ trigger.to_state.attributes.current_activity }}'
